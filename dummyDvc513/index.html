<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Google Tag Manager -->
   <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
   new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
   j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
   'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
   })(window,document,'script','dataLayer','GTM-MBCBVQS');</script>
   <!-- End Google Tag Manager -->

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Productivity Calculator</title>
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:400,700" rel="stylesheet">
    <link rel="stylesheet" href="lib/globalStyle.css" />
    <link href="css/styles.css" rel="stylesheet">
    <link href="lib/select2.min.css" rel="stylesheet" />
    <link href="lib/bootstrap-grid.css" rel="stylesheet" />
    <link href="lib/details-shim.css" rel="stylesheet" />


  </head>
<body>
    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-MBCBVQS"
    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->

    <h1>How productive is your business?</h1>
    <div id="results0div" style="display:block">
      <div class="row">
        <div class="col-xs-12 col-sm-6">
          <h3>Reporting period</h3>
          <div id="dropdown2"></div>
        </div>

        <div class="col-xs-12 col-sm-6">
          <h3>Turnover/sales</h3>
          <div class="input-value">
            <form class="input">
              <div class="pound">
                £
              </div>
              <div class="input-window">
                <input style="text-align: right;" id="turnover-input" type="number"  min="0" value="0">
              </div>
            </form>
          </div>
        </div>

        <div class="col-xs-12 col-sm-6">
          <h3>Intermediate consumption</h3>
          <p>Non-capital purchases</p>
          <div class="input-value">
            <form class="input">
              <div class="pound">
                £
              </div>
              <div class="input-window">
                <input style="text-align: right;" id="expense-input" type="number" min="0" value="0">
              </div>
            </form>
          </div>
        </div>

        <div class="col-xs-12 col-sm-6">
            <h3>Workers</h3>
            <p>Employees and working proprietors</p>
            <div class="input-value">
              <form class="input">
                <div class="pound spinner-down">
                <span class="spinner-button">-</span>
              </div>
                <div class="spinner-inner">
                  <input class="spinner-input" id="employees" type="number" min="0" value="0">
                </div>
                <div class="pound spinner-up">
                <span class="spinner-button" style="pointer-events:none;">+</span>
              </div>
              </form>
            </div>
        </div>

      </div>

      <details id="details1" class="details">
        <summary class="details__summary">
          <span class="details__summary-text">
            Definitions
          </span>
        </summary>
        <div class="details__text">
          <p><strong>Turnover:</strong> Turnover consists of total takings or invoiced sales and receipts of the business in connection with the sale of goods and services. Figures should be given gross of indirect taxes, duties and levies (except VAT) invoiced to the customer. Interest and similar income, other operating income and extra-ordinary income should be excluded from the turnover figure as should net proceeds on sales of capital items. </p>
          <p><strong>Intermediate consumption (Expenses):</strong> Intermediate consumption is the cost of raw materials and other inputs that are used up in the production process.</p>
          <p><strong>Workers:</strong> This includes employees and working proprietors. An employee is anyone aged 16 years or over that your organisation directly pays from its payroll(s), in return for carrying out a full-time or part-time job or being on a training scheme.  Working proprietors include all individuals and partners actively engaged in the work of the business. It excludes silent or inactive partners whose main activity is outside of the business.</p>
        </div>
      </details>

<div class="input-value">      <form class="input"><br/>

    <button class="btn-primary large" onclick="checkNext1()" type="button">Next ▶</button></form>
</div>

<div id="warning">
</div>


  </div>
    <div id="resultsdiv" style="display:none;">
    <h2>Results: 1/2</h2>
    <h3>Your company's productivity</h3>

    <div class="highlightbox highlight1">
      <strong><p>Your company's gross value added per worker in <span id="reportingperiod"></span> is <br><span style="font-size:28px;line-height:32px;">£<span id="GVA-input"></span><span></p></strong>
    </div>

    <details id="details2" class="details">
      <summary class="details__summary">
        <span class="details__summary-text">
          Definitions
        </span>
      </summary>
      <div class="details__text">
        <p><strong>Gross value added:</strong> GVA is the difference between total output and intermediate consumption. That is the difference between the value of goods and services produced and the cost of raw materials and other inputs that are used up in production.</p>
        <p><strong>Productivity:</strong> Productivity is defined as the ratio between output and input. Our measure of output is gross value added (GVA) and our measure of labour input is workers (employees and working proprietors).</p>

      </div>
    </details>

    <h3>How do you compare to your industry?</h3>

      <div class="dropdown" id="dropdown"></div>
      <div class="dropdown" id="dropdown3"></div>

      <div id="industrywarning"></div>

      <button class="btn-primary large" onclick="goBack()" type="button">◀ Back </button>
      <button class="btn-primary large" onclick="checkNext2()" type="button">Next ▶</button>
    </div>

    <div id="warning2">
    </div>

    <div id="results2div" style="display:none;">
      <h2>Results: 2/2</h2>
      <h3>Within your industry</h3>
      <div class="highlightbox highlight2">
        <strong><p>The productivity of the average firm in the <span  id="industryspan"></span> industry is<br/><span style="font-size:28px;line-height:32px;">£</span><span style="font-size:28px;line-height:32px;" id="productivity0">XX,XXX</span></strong>.</p>
      </div>
      <div id="warning3"></div>

      <div id="svg1"></div>

      <div class="highlightbox highlight2" id="industrysizeresults">
        <strong><p>The productivity of the average firm with <span id="sizespan"></span> workers in the <span id="industryspan2"></span> industry is<br/><span style="font-size:28px;line-height:32px;">£<span id="productivity1">XX,XXX</span></span></strong>.</p>
      </div>
      <button class="btn-primary large" onclick="goBack2()" type="button">◀ Back </button>
<button class="btn-primary large" onclick="startagain()" type="button">Start again</button>
  </div>

    <!--Library-->

    <script src="https://cdn.ons.gov.uk/vendor/jquery/2.1.4/jquery.min.js"></script>
    <script src="https://cdn.ons.gov.uk/vendor/d3/4.2.7/d3.js"></script>
    <script src="lib/modernizr.svg.min.js" type="text/javascript"></script>
    <script src="../lib/queue.js" type="text/javascript"></script>
    <script src="https://cdn.ons.gov.uk/vendor/pym/1.3.2/pym.min.js" type="text/javascript"></script>
    <script src="lib/select2.min.js"></script>
    <script src="lib/details-shim.js"></script>




    <script>

	function initialise() {

	 pymChild = new pym.Child();

   d3.queue()
   .defer(d3.csv,"industry.csv")
   .defer(d3.csv,"industrysize.csv")
   .defer(d3.csv,"SIC07-tomatch.csv")
   .await(ready);


   timeperiods=[2016,2015,2014,2013,2012,2011,2010]

   if(document.getElementById("period")==null){
     d3.select("#dropdown2").append("select").attr("id","period").attr("style","width:95%")
   }

   d3.select("#period").append("option")
   d3.select("#period").selectAll("p").data(timeperiods).enter().append("option")
   .attr("value",function(d){return d})
   .text(function(d){return d});
   $('#period').select2({placeholder:"Select your reporting period",minimumResultsForSearch: -1, allowClear:true})

  d3.select(".spinner-up").on("click",function(){
    var employees=document.getElementById("employees").value
    document.getElementById("employees").value=+employees+1
  })

  d3.select(".spinner-down").on("click",function(){
    if(document.getElementById("employees").value>0){
      var employees=document.getElementById("employees").value
      document.getElementById("employees").value=+employees-1
      }
  })

    function ready(error,data,size,names){
      industrynames=[]
      for(i=0;i<names.length;i++){
        industrynames.push(names[i]["Column"])
      }

      // get uniques
      industrynames=d3.map(industrynames,function(d){return d}).keys()

       //dropdown
       if(document.getElementById("droppy")==null){
         d3.select("#dropdown").append("select").attr("id","droppy").attr("style","width:95%")
       }

       //blank option for placeholder
       d3.select("#droppy").append("option")

       d3.select("#droppy").selectAll("p").data(industrynames).enter().append("option")
       .attr("value", function(d){return d})
       .text(function(d){return d});

        $('#droppy').select2({placeholder:"Select your industry",allowClear:true})

        graphic_data=data;
        size_data=size;
        graphic_names=names;

        //industry conditional
            $('#droppy').on('select2:select',function(e){
              selected=e.params.data.text
              // console.log(selected)

              dataLayer.push({
                  "event": "pyramidDropSelect",
                  "selected": selected
              })
              //show subindustry dropdown
              d3.select("#dropdown3").style("display","block")
              //clear subindustry dropdown
              d3.select("#droppy3").selectAll("*").remove();
              //filter names
              subindustrynames=names.filter(function(d){return d.Column==selected})
              // console.log(subindustrynames)

              if(subindustrynames.length>1){//if there are sub industries
                //if the dropdown doesn't exist, append one
                if(document.getElementById("droppy3")==null){
                  d3.select("#dropdown3").append("select").attr("id","droppy3").attr("style","width:95%").attr("display","none")
                }
                d3.select("#droppy3").append("option")
                d3.select("#droppy3").selectAll("p").data(subindustrynames).enter().append("option")
                .attr("value", function(d){return d.Column2})
                .text(function(d){return d.Column2});

                $('#droppy3').select2({placeholder:"Select your sub-industry",allowClear:true})

              }else{
                //hide sub industry dropdown
                d3.select("#dropdown3").style("display","none")
                //clear sub industry dropdown
                // d3.select("#droppy3").selectAll("*").remove();
              }//end of if

            })//end of industry conditional

            //industry warnings
            $('#droppy').on('select2:select',function(e){
                    if(selected=="Agriculture, forestry and fishing"){
                      d3.select("#industrywarning").selectAll("*").remove();
                      d3.select("#industrywarning").append("div").attr("class","highlightbox").style("background-color","#F99C21").append("p").text("Agriculture only covers Support activities to agriculture and post-harvest crop activities and Hunting, trapping and related service activities.").style("color","white");
                      pymChild.sendHeight();
                    }else if(selected=="Education"){
                      d3.select("#industrywarning").selectAll("*").remove();
                      d3.select("#industrywarning").append("div").attr("class","highlightbox").style("background-color","#F99C21").append("p").text("Education excludes the public sector.").style("color","white");
                      pymChild.sendHeight();
                    }else if(selected=="Human health and social work activities"){
                      d3.select("#industrywarning").selectAll("*").remove();
                      d3.select("#industrywarning").append("div").attr("class","highlightbox").style("background-color","#F99C21").append("p").text("Human health and social work activities” excludes the public sector and dental practice activities.").style("color","white");
                      pymChild.sendHeight();
                    }else if(selected=="Insurance, reinsurance and pension funding, except compulsory social security"){
                      d3.select("#industrywarning").selectAll("*").remove();
                      d3.select("#industrywarning").append("div").attr("class","highlightbox").style("background-color","#F99C21").append("p").text("Only covers Insurance and Reinsurance.").style("color","white");
                      pymChild.sendHeight();
                    }else{
                      d3.select("#industrywarning").selectAll("*").remove();
                      pymChild.sendHeight();
                    }
            })

            $('#droppy').on('select2:unselect',function(e){
              d3.select("#industrywarning").selectAll("*").remove();
              pymChild.sendHeight();
            })

            $('#droppy3').on('select2:select',function(f){
                selected2=f.params.data.text;
                dataLayer.push({
                    "event": "pyramidDropSelect",
                    "selected": selected2
                })
            })


            // Select the node that will be observed for mutations
            var targetNode = document.getElementById('details1');
            var targetNode2 = document.getElementById('details2');

            // Options for the observer (which mutations to observe)
            var config = { attributes: true};

            // Callback function to execute when mutations are observed
            var callback = function(mutationsList) {
              for (var _i = 0, _a = mutationsList; _i < _a.length; _i++) {
                var mutation = _a[_i];
                if (mutation.type == 'attributes') {
                    pymChild.sendHeight();
                }

              }



                // for(var mutation of mutationsList); {
                //     if (mutation.type == 'attributes') {
                //         pymChild.sendHeight();
                //     }
                // }
            };

            // Create an observer instance linked to the callback function
            var observer = new MutationObserver(callback);

            // Start observing the target node for configured mutations
            observer.observe(targetNode, config);
            observer.observe(targetNode2, config);



    }//end of ready

   	} //end initialise

    function goBack(){
      d3.select("#results0div").style("display","block")
      d3.select("#resultsdiv").style("display","none")
      d3.selectAll(".highlightbox").style("display","none")
      dataLayer.push({
        'event': 'buttonClicked',
        'selected': 'back1'
      })
      pymChild.sendHeight();
    }

    function goBack2(){
      d3.select('svg').remove()
      d3.select("#resultsdiv").style("display","block")
      d3.select("#results2div").style("display","none")
      dataLayer.push({
        'event': 'buttonClicked',
        'selected': 'back2'
      })
      pymChild.sendHeight();
    }

    function startagain(){
      d3.select('svg').remove()
      d3.selectAll(".highlightbox").style("display","block")
      d3.select("#results0div").style("display","block")
      d3.select("#resultsdiv").style("display","none")
      d3.select("#results2div").style("display","none")
      dataLayer.push({
        'event': 'buttonClicked',
        'selected': 'startagain'
      })
      // d3.select("#").selectAll("*").remove();
      // d3.select("#droppy3").selectAll("*").remove();

    }

    function checkNext1(){
      turnoverperyear=+document.getElementById("turnover-input").value
      expensesperyear=+document.getElementById("expense-input").value
      employees=+document.getElementById("employees").value
      reportingperiod=document.getElementById("period").value


      d3.select("#warning").selectAll("*").remove()

            if(turnoverperyear==0||""){
            d3.select("#warning").append("div").attr("class","highlightbox").style("background-color","#F99C21").append("h3").text("Please fill out all the fields").style("color","white")
            pymChild.sendHeight()
          }else if(    expensesperyear==0||""){
            d3.select("#warning").append("div").attr("class","highlightbox").style("background-color","#F99C21").append("h3").text("Please fill out all the fields").style("color","white")
            pymChild.sendHeight()
          }else if(    employees==0||""){
            d3.select("#warning").append("div").attr("class","highlightbox").style("background-color","#F99C21").append("h3").text("Please fill out all the fields").style("color","white")
            pymChild.sendHeight()
          }else if(    reportingperiod==""){
            d3.select("#warning").append("div").attr("class","highlightbox").style("background-color","#F99C21").append("h3").text("Please fill out all the fields").style("color","white")
            pymChild.sendHeight()
          }else(calculate())
    }



    function calculate(){

    d3.select("#results0div").style("display","none")
    d3.select("#resultsdiv").style("display","block")
    d3.selectAll(".highlightbox").style("display","block")

    gvaperworker=(turnoverperyear-expensesperyear)/employees
    document.getElementById("GVA-input").innerHTML=d3.format(",.0f")(gvaperworker)
    document.getElementById("reportingperiod").innerHTML=reportingperiod
    if(gvaperworker<0){
      d3.selectAll(".warning").remove();
      d3.select(".highlight1").append('hr').attr("class","warning");
      d3.select(".highlight1").append("p").attr("class","warning").text("You have a negative gross value added per worker. This means your expenditure on inputs was greater than the turnover you generated.");
      d3.select(".highlight1").style("background-color","#F99C21")
    }else{
      d3.selectAll(".warning").remove();
      d3.select(".highlight1").style("background-color","#0F8243")
    }
    pymChild.sendHeight();

    dataLayer.push({
      'event': 'buttonClicked',
      'selected': 'Next1'
    })
  }//end of Calculate

  function checkNext2(){
    //if(typeof(document.getElementById("droppy3"))!='undefined'&&document.getElementById("droppy3")!= null){industry=document.getElementById("droppy3").value}
    if(document.getElementById("droppy3")!= null){
      if(document.getElementById("dropdown3").style.display!="none"){industry=document.getElementById("droppy3").value}
      else{industry=document.getElementById("droppy").value}
    }
    else{industry=document.getElementById("droppy").value}
    // else if(typeof(document.getElementById("droppy3"))!='undefined'&&document.getElementById("droppy3")!= null&&document.getElementById("droppy3").value==""){industry=document.getElementById("droppy").value}
    //else if(document.getElementById("dropdown3").style.display=="none"){industry=document.getElementById("droppy").value}else{industry=document.getElementById("droppy").value}
    d3.select("#warning2").selectAll("*").remove()
    if(industry==""){
      d3.select("#warning2").append("div").attr("class","highlightbox").style("background-color","#F99C21").append("h3").text("Please select an industry").style("color","white")
      pymChild.sendHeight()
    }else(calculate2())

  }//end of checkNext2

  function calculate2(){
    dummyarray=[0,10,25,50,75,90,100]
    midpointsarray=[5,17.5,37.5,62.5,82.5,95]
    percentilearray=[10,25,50,75,90]

    d3.select("#resultsdiv").style("display","none")
    d3.select("#results2div").style("display","block")

    industrymean=graphic_data
        .filter(function(d){return d["Year"]==reportingperiod})
        .filter(function(d){return d["Industry name"]==industry})

    industrymeanarray=[]
    industrymeanarray.push(industrymean[0].P10)
    industrymeanarray.push(industrymean[0].P25)
    industrymeanarray.push(industrymean[0].P50)
    industrymeanarray.push(industrymean[0].P75)
    industrymeanarray.push(industrymean[0].P90)
    industrymeanarray.push(99999999999999)

    bandlimit=industrymeanarray.find(function(e){return e>gvaperworker})
    bandindex=industrymeanarray.indexOf(bandlimit)

    if(employees<10){sizeband="0–9"}
    else if (employees>=10&&employees<50) {sizeband="10–49"}
    else if (employees>=50&&employees<250) {sizeband="50–249"}
    else if (employees>=250){sizeband="250+"}


    industrysizedata=size_data
    .filter(function(d){return d["Year"]==reportingperiod})
    .filter(function(d){return d["Industry name"]==industry})[0][sizeband]



    //check if data exists

    // if(industrysizedata===undefined||industrymean==0){
    //   d3.selectAll(".highlightbox").style("display","none")
    //   d3.select("#warning3").append("div").attr("class","highlightbox").style("background-color","#F99C21").append("h3").text("Sorry, we don't have data for your industry").style("color","white")
    // }else{
    d3.select("#warning3").selectAll("*").remove()
    d3.selectAll(".highlightbox").style("display","block")
    document.getElementById("productivity0").innerHTML=d3.format(",.0f")(industrymean[0].Mean)

    document.getElementById("industryspan").innerHTML=(industry.charAt(0).toLowerCase() + industry.slice(1))
    document.getElementById("industryspan2").innerHTML=(industry.charAt(0).toLowerCase() + industry.slice(1))
    document.getElementById("sizespan").innerHTML=sizeband
    document.getElementById("productivity1").innerHTML=d3.format(",.0f")(+industrysizedata)

    if(industrysizedata==0){
      d3.select("#industrysizeresults").style("display","none")
    }

    //let's make some svgs
    width=parseInt(d3.select("#results2div").style("width"))
    if(width<600){//mobile breakpoint
        height=width*1.36
        margin={top:20,right:50,bottom:20,left:120}
        d3.select("#svg1").append('svg').attr("id","chart")
        .attr("width",width)
        .attr("height",height+margin.top+margin.bottom)
        .append("g").attr("id","chart2")
        .attr("transform","translate("+margin.left+","+margin.top+")");

        y=d3.scaleLinear()
          .range([0,height])
          .domain([0,100])

        //make the rects
        for(i=0;i<dummyarray.length-1;i++){
          d3.select("#chart2")
            .append('rect').attr("id","rect"+(dummyarray.length-2-i))
            .attr("y",function(){return y(dummyarray[i])})
            .attr("width",50)
            .attr("height",function(){return Math.abs(y(dummyarray[i])-y(dummyarray[i+1]))})
            .style("fill","#c8e3f3")

            d3.select("#chart2")
                .append("line").attr("id","line"+1)
                .attr("y1",y(dummyarray[i]))
                .attr("y2",y(dummyarray[i]))
                .attr("x1",0)
                .attr("x2",50)
                .style("stroke","white")
                .style("stroke-width",3)
          }

          d3.select("#rect"+bandindex)
          .style("fill","#206095")

          //add labels to scales
          d3.select("#chart2").append("text")
          .attr("y",height-y(100)-5)
          .attr("x",20)
          // .attr("dy","-2em")
          .attr("fill", "#003C57")
          .attr("text-anchor","start")
          .text("🔺 High productivity")

          d3.select("#chart2").append("text")
          .attr("y",height-y(0)+8)
          .attr("x",20)
          .attr("dy","0.5em")
          .attr("fill", "#003C57")
          .attr("text-anchor","start")
          .text("🔻 Low productivity")

          //add the labels to the rects
          d3.select("#chart2").append('g').attr("id","chart3").attr("transform","translate(0,8)")
          for(i=0;i<industrymeanarray.length-1;i++){
          d3.select("#chart3")
          .append("text")
          .attr("y",height-y(dummyarray[i+1]))
          .attr("x",60)
          .attr("text-anchor","start")
          .attr("font-weight","bolder")
          .text("£"+d3.format(",.0f")(industrymeanarray[i]))

          d3.select("#chart3")
          .append("text")
          .attr("y",height-y(dummyarray[i+1]))
          .attr("x",60)
          .attr("dy","1.2em")
          .attr("text-anchor","start")
          .attr("font-weight","normal")
          .text(percentilearray[i]+"th percentile")
          }

          //make a pointer
          d3.select("#chart2").append("path").attr("id","pointer")
          .attr("d","M-39.469,12v45.573c0,6.627,5.373,12,12,12h73.281	c6.627,0,12-5.373,12-12l0.25-11.474l11.313-11.313L58.063,23.475L57.813,12c0-6.627-5.373-12-12-12h-73.281 C-34.095,0-39.469,5.373-39.469,12z")
          .attr("fill","#206095")
          .attr("transform","translate(-67,"+(height-y(midpointsarray[bandindex])-35)+")")

          d3.select("#chart2").append("text")
          .attr("id","tspans")
          .append("tspan")
          .attr("y",height-y(midpointsarray[bandindex])-12)
          .attr("x",-58)
          .attr("dy","0")
          .attr("text-anchor","middle")
          .style("fill","white")
          .text("Your")

          d3.select("#tspans").append("tspan")
          .attr("y",height-y(midpointsarray[bandindex])-12)
          .attr("x",-58)
          .attr("dy","1.2em")
          .attr("text-anchor","middle")
          .style("fill","white")
          .text("firm")

          d3.select("#tspans").append("tspan")
          .attr("y",height-y(midpointsarray[bandindex])-12)
          .attr("x",-58)
          .attr("dy","2.4em")
          .attr("text-anchor","middle")
          .style("fill","white")
          .text("£"+d3.format(",.0f")(gvaperworker))

    }//end of mobile stuff
    else
    {//start of non mobile stuff
      width=0.95*width
    height=width*0.2
    margin={top:100,right:50,bottom:10,left:0}

    d3.select("#svg1").append('svg').attr("id","chart")
    .attr("width",width+margin.right)
    .attr("height",height+margin.top+margin.bottom)
    .append("g").attr("id","chart2")
    .attr("transform","translate("+margin.left+","+margin.top+")");

    x=d3.scaleLinear()
      .range([0,width])
      .domain([0,100])

    //make the rects
    for(i=0;i<dummyarray.length-1;i++){
      d3.select("#chart2")
        .append('rect').attr("id","rect"+i)
        .attr("x",function(){return x(dummyarray[i])})
        .attr("height",50)
        .attr("width",function(){return Math.abs(x(dummyarray[i])-x(dummyarray[i+1]))})
        .style("fill","#c8e3f3")

      d3.select("#chart2")
          .append("line").attr("id","line"+1)
          .attr("x1",x(dummyarray[i]))
          .attr("x2",x(dummyarray[i]))
          .attr("y1",0)
          .attr("y2",50)
          .style("stroke","white")
          .style("stroke-width",3)
    }
    //make selected rect a certain colour
    d3.select("#rect"+bandindex)
    .style("fill","#206095")


    //add labels to scales
    d3.select("#chart2").append("text")
    .attr("x",x(100))
    .attr("y",-10)
    .attr("fill", "#003C57")
    .attr("text-anchor","end")
    .text("High productivity ▶")

    d3.select("#chart2").append("text")
    .attr("x",x(0))
    .attr("y",-10)
    .attr("fill", "#003C57")
    .attr("text-anchor","start")
    .text("◀ Low productivity")

    //add the labels to the rects
        d3.select("#chart2").append('g').attr("id","chart3").attr("transform","translate(0,50)")
    for(i=0;i<industrymeanarray.length-1;i++){
    d3.select("#chart3")
    .append("text")
    .attr("x",x(dummyarray[i+1]))
    .attr("y",20)
    .attr("text-anchor","middle")
    .attr("font-weight","bolder")
    .text("£"+d3.format(",.0f")(industrymeanarray[i]))

    d3.select("#chart3")
    .append("text")
    .attr("x",x(dummyarray[i+1]))
    .attr("y",20)
    .attr("dy","1.2em")
    .attr("text-anchor","middle")
    .attr("font-weight","normal")
    .text(percentilearray[i]+"th")

    d3.select("#chart3")
    .append("text")
    .attr("x",x(dummyarray[i+1]))
    .attr("y",20)
    .attr("dy","2.4em")
    .attr("text-anchor","middle")
    .attr("font-weight","normal")
    .text("percentile")
    }


    //make a pointer
    d3.select("#chart2").append("path").attr("id","pointer")
    .attr("d","M46.063,0h-73.531c-6.627,0-12,5.373-12,12v34.01 c0,6.627,5.373,12,12,12l25.453,0.25L9.298,69.573L20.61,58.26l25.453-0.25c6.627,0,12-5.373,12-12V12 C58.063,5.373,52.69,0,46.063,0z")
    .attr("fill","#206095")
    .attr("transform","translate("+(x(midpointsarray[bandindex])-10)+",-90)")

    d3.select("#chart2").append("text")
    .attr("id","tspans")
    .append("tspan")
    .attr("x",x(midpointsarray[bandindex]))
    .attr("y",-76)
    .attr("dy","0")
    .attr("text-anchor","middle")
    .style("fill","white")
    .text("Your")

    d3.select("#tspans").append("tspan")
    .attr("x",x(midpointsarray[bandindex]))
    .attr("y",-76)
    .attr("dy","1.2em")
    .attr("text-anchor","middle")
    .style("fill","white")
    .text("firm")

    d3.select("#tspans").append("tspan")
    .attr("x",x(midpointsarray[bandindex]))
    .attr("y",-76)
    .attr("dy","2.4em")
    .attr("text-anchor","middle")
    .style("fill","white")
    .text("£"+d3.format(",.0f")(gvaperworker))



  }//end of if mobile else desktop

  pymChild.sendHeight();
  dataLayer.push({
    'event': 'buttonClicked',
    'selected': 'Next2'
  })//end of data layer
// }//end of check if data
  }//end of calculate2




  //some code to stop select2 opening when clearing
  $('#dropdown').on('select2:unselecting', function(ev) {
      if (ev.params.args.originalEvent) {
          // When unselecting (in multiple mode)
          ev.params.args.originalEvent.stopPropagation();
      } else {
          // When clearing (in single mode)
          $(this).one('select2:opening', function(ev) { ev.preventDefault(); });
      }
  });


    //check whether browser can cope with svg
    if (Modernizr.svg) {
		  pymChild = new pym.Child({ renderCallback: initialise });
    } else {
       //use pym to create iframe containing fallback image (which is set as default)
       pymChild = new pym.Child();
      if (pymChild) {
            pymChild.sendHeight();
        }
    }

    //polyfill the Array.find function for IE
    // https://tc39.github.io/ecma262/#sec-array.prototype.find
    if (!Array.prototype.find) {
      Object.defineProperty(Array.prototype, 'find', {
        value: function(predicate) {
         // 1. Let O be ? ToObject(this value).
          if (this == null) {
            throw new TypeError('"this" is null or not defined');
          }

          var o = Object(this);

          // 2. Let len be ? ToLength(? Get(O, "length")).
          var len = o.length >>> 0;

          // 3. If IsCallable(predicate) is false, throw a TypeError exception.
          if (typeof predicate !== 'function') {
            throw new TypeError('predicate must be a function');
          }

          // 4. If thisArg was supplied, let T be thisArg; else let T be undefined.
          var thisArg = arguments[1];

          // 5. Let k be 0.
          var k = 0;

          // 6. Repeat, while k < len
          while (k < len) {
            // a. Let Pk be ! ToString(k).
            // b. Let kValue be ? Get(O, Pk).
            // c. Let testResult be ToBoolean(? Call(predicate, T, « kValue, k, O »)).
            // d. If testResult is true, return kValue.
            var kValue = o[k];
            if (predicate.call(thisArg, kValue, k, o)) {
              return kValue;
            }
            // e. Increase k by 1.
            k++;
          }

          // 7. Return undefined.
          return undefined;
        },
        configurable: true,
        writable: true
      });
    }

	  </script>

  </body>
</html>
